<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dune Query</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .container {
            max-width: 1000px;
        }
        .query-box {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .results-box {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .explanation {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 1rem;
            margin-top: 1rem;
        }
        h1 {
            color: #343a40;
            margin-bottom: 2rem;
            text-align: center;
        }
        .query-id {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .tab-content {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Dune Query</h1>
        
        <div class="query-box">
            <h3>Ask a question about blockchain data</h3>
            <p class="text-muted">Enter your question in natural language, and AI will convert it to a Dune Analytics query.</p>
            
            <div class="mb-3">
                <textarea id="query-input" class="form-control" rows="3" placeholder="e.g., What was the daily transaction volume on Ethereum over the past week?"></textarea>
            </div>
            
            <div class="d-grid">
                <button id="submit-btn" class="btn btn-primary">Submit Query</button>
            </div>
        </div>
        
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing your query...</p>
        </div>
        
        <div id="results" class="results-box">
            <h3>Query Results</h3>
            
            <div id="query-info" class="mb-4">
                <p id="query-explanation" class="mb-2"></p>
                <p id="query-id" class="query-id mb-0"></p>
            </div>
            
            <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="explanation-tab" data-bs-toggle="tab" data-bs-target="#explanation" type="button" role="tab" aria-controls="explanation" aria-selected="true">Explanation</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab" aria-controls="data" aria-selected="false">Data</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw" type="button" role="tab" aria-controls="raw" aria-selected="false">Raw JSON</button>
                </li>
            </ul>
            
            <div class="tab-content" id="resultTabsContent">
                <div class="tab-pane fade show active" id="explanation" role="tabpanel" aria-labelledby="explanation-tab">
                    <div id="result-explanation" class="explanation"></div>
                </div>
                <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">
                    <div class="table-container">
                        <table id="result-table" class="table table-striped">
                            <thead id="result-table-head"></thead>
                            <tbody id="result-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="raw" role="tabpanel" aria-labelledby="raw-tab">
                    <pre id="raw-json" class="p-3 bg-light"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const queryInput = document.getElementById('query-input');
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.querySelector('.loading');
            const results = document.getElementById('results');
            const queryExplanation = document.getElementById('query-explanation');
            const queryId = document.getElementById('query-id');
            const resultExplanation = document.getElementById('result-explanation');
            const resultTableHead = document.getElementById('result-table-head');
            const resultTableBody = document.getElementById('result-table-body');
            const rawJson = document.getElementById('raw-json');
            
            submitBtn.addEventListener('click', async function() {
                const query = queryInput.value.trim();
                
                if (!query) {
                    alert('Please enter a query');
                    return;
                }
                
                // Show loading, hide results
                loading.style.display = 'block';
                results.style.display = 'none';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/api/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ query })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    // Display query information
                    queryExplanation.textContent = `SQL查询: ${data.sql || data.original_sql || ""}`;
                    queryId.textContent = data.optimized_sql ? `优化后的SQL: ${data.optimized_sql}` : "";
                    
                    // 获取结果解释
                    let explanation = "";
                    try {
                        const explainResponse = await fetch('/api/explain', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                result: data.result,
                                query: query 
                            })
                        });
                        
                        const explainData = await explainResponse.json();
                        explanation = explainData.explanation || "无法生成解释";
                    } catch (explainError) {
                        explanation = "获取解释时出错: " + explainError.message;
                    }
                    
                    // Display explanation
                    resultExplanation.innerHTML = explanation.replace(/\n/g, '<br>');
                    
                    // Display raw JSON
                    rawJson.textContent = JSON.stringify(data.result, null, 2);
                    
                    // Create table from rows
                    if (data.result && data.result.length > 0) {
                        const columns = Object.keys(data.result[0]);
                        
                        // Create table header
                        let headerHtml = '<tr>';
                        columns.forEach(column => {
                            headerHtml += `<th>${column}</th>`;
                        });
                        headerHtml += '</tr>';
                        resultTableHead.innerHTML = headerHtml;
                        
                        // Create table body
                        let bodyHtml = '';
                        data.result.forEach(row => {
                            bodyHtml += '<tr>';
                            columns.forEach(column => {
                                bodyHtml += `<td>${row[column] !== null ? row[column] : ''}</td>`;
                            });
                            bodyHtml += '</tr>';
                        });
                        resultTableBody.innerHTML = bodyHtml;
                    } else {
                        resultTableHead.innerHTML = '';
                        resultTableBody.innerHTML = '<tr><td>没有可用数据</td></tr>';
                    }
                    
                    // Show results
                    results.style.display = 'block';
                    
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    loading.style.display = 'none';
                    submitBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
